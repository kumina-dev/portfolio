---
import PageLayout from "../../layouts/PageLayout.astro";
import Card from "../../components/ui/Card.astro";
import Chip from "../../components/ui/Chip.astro";
import { getProjects } from "../../lib/content";

const projects = await getProjects();
const allTags = Array.from(new Set(projects.flatMap((p) => p.data.tags))).sort();
---
<PageLayout title="Projects">
    <div class="flex items-end justify-between gap-4">
        <div>
            <h1 class="text-2xl font-semibold">Projects</h1>
            <p class="mt-2 ui-muted">Case studies in a consistent format.</p>
        </div>
        <input
            id="q"
            class="ui-field ui-interactive w-[min(360px,55vw)] rounded-xl px-3 py-2 text-sm outline-none"
            placeholder="Search projectsâ€¦"
        />
    </div>

    <div class="mt-6 flex flex-wrap gap-2" id="tagbar">
        <button class="tag ui-interactive ui-interactive-surface rounded-full border ui-border bg-[rgba(var(--panel),0.7)] px-3 py-1 text-xs ui-muted-soft" data-tag="">
            All
        </button>
        {allTags.map((t) => (
            <button class="tag ui-interactive ui-interactive-surface rounded-full border ui-border bg-[rgba(var(--panel),0.7)] px-3 py-1 text-xs ui-muted-soft" data-tag={t}>
                {t}
            </button>
        ))}
    </div>

    <div class="mt-6 grid gap-4 md:grid-cols-2" id="grid">
        {projects.map((p) => (
            <a
                href={`/projects/${p.data.slug}`}
                class="proj ui-interactive block"
                data-title={p.data.title.toLowerCase()}
                data-tags={p.data.tags.join(",").toLowerCase()}
            >
                <Card class="proj-card p-5">
                    <div class="flex items-center justify-between gap-4">
                        <div class="text-lg ui-text">{p.data.title}</div>
                        <div class="font-mono text-xs ui-muted-faint">{p.data.date}</div>
                    </div>
                    <p class="mt-2 text-sm ui-muted">{p.data.summary}</p>
                    <div class="mt-3 flex flex-wrap gap-2">
                        {p.data.stack.slice(0, 4).map((s) => <Chip text={s} />)}
                    </div>
                </Card>
            </a>
        ))}
    </div>

    <script>
        const q = document.getElementById("q");
        const grid = document.getElementById("grid");
        const tagbar = document.getElementById("tagbar");

        let activeTag = "";

        function apply() {
            const query = (q.value || "").trim().toLowerCase();
            const cards = grid.querySelectorAll(".proj");
            cards.forEach((el) => {
                const title = el.dataset.title || "";
                const tags = el.dataset.tags || "";
                const okQ = !query || title.includes(query);
                const okT = !activeTag || tags.includes(activeTag.toLowerCase());
                el.style.display = (okQ && okT) ? "block" : "none";
            });
        }

        tagbar.addEventListener("click", (e) => {
            const btn = e.target.closest("button[data-tag]");
            if (!btn) return;
            activeTag = btn.dataset.tag || "";
            tagbar.querySelectorAll("button[data-tag]").forEach(b => b.classList.remove("ring-2"));
            btn.classList.add("is-active");
            apply();
        });

        q.addEventListener("input", apply);
        apply();
    </script>
</PageLayout>